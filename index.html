<!DOCTYPE html>
<html>
<head>
    <style>
        .line { overflow:hidden; }
        .box {
            margin: 2px;
            float: left;
            border-radius: 3px;
        }
        .chamber {
            margin: 2px;
            float: left;
            width: 100px;
            height: 100px;
            background: Red;
            border-radius: 3px;
        }
        .enable { background: Gray; }
        .enable:hover { background: Black; }
        .live { background: Green; }
        .dead { background: Red; }
        h2 { font-family: 'Noto Sans', sans-serif; }
    </style>

    <script src = "http://code.jquery.com/jquery-2.1.4.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script src = "/socket.io/socket.io.js"></script>

    <script>
        var gun_shot_sound = new Audio('sound/gun-shot.mp3');
        var gun_dry_sound = new Audio('sound/gun-dry.mp3');

        function gun_shot() {
            gun_shot_sound.currentTime = 0;
            gun_shot_sound.play();
        }

        function gun_dry() {
            gun_dry_sound.currentTime = 0;
            gun_dry_sound.play();
        }

    </script>
    <script>
        var socket = io.connect();

        socket.on('shot', function (data) {
            var $target = $('div[data-x = ' + data.x + ']');
            $target.removeClass('enable');
            if (data.result == 2) {
                $target.addClass('live');
            } else if (data.result == 4) {
                $target.addClass('dead');
            }
        });

        var onClickSlot = function () {
            gun_dry();
            var x = $(this).attr('data-x');

            $(this).off('click');
            socket.emit('shot', { x: x });
        };

        var onClickTrap = function () {
            gun_shot();
            alert("당첨!");

            var x = $(this).attr('data-x');

            $(this).off('click');
            socket.emit('shot', { x: x });
        };

        function reloadCylinder() {
            $.getJSON('/cylinder', { dummy: new Date().getTime() }, function (data) {

                var $line = $('<div></div>', {
                    'class': 'form-group'
                }).addClass('line');

                $.each(data, function (indexX, chamber) {
                    var $box = $('<div></div>', {
                        'class': 'box col-md-2'
                    }).appendTo($line);

                    var $chamber = $('<div></div>', {
                        'class': 'chamber',
                        'data-x': indexX
                    }).appendTo($box);

                    $('<input>', {
                        'type': 'text",',
                        'value': chamber.name,
                        'class': 'form-control'
                    }).appendTo($box);

                    if (chamber.status == 1) {
                        $chamber.addClass('enable').on('click', onClickSlot);
                    } else if (chamber.status == 2) {
                        $chamber.addClass('live');
                    } else if (chamber.status == 3) {
                        $chamber.addClass('enable').on('click', onClickTrap);
                    } else if (chamber.status == 4) {
                        $chamber.addClass('dead');
                    } else {
                        console.log("something wrong; status=" + chamber.status);
                    }
                });

                $('#roulette').html('');
                $line.appendTo('#roulette');
            });
        }

        socket.on('reset', function (data) {
            reloadCylinder();
        });
    </script>

    <script>
        function redrawNameForm(num) {
            var names = getChamberNames();

            var $line = $('<div></div>', {
                'class': 'form-group'
            }).addClass('line');

            function getName(names, i) {
                var sampleNames = ['tiger', 'rabbit', 'mouse', 'horse', 'elephant', 'fox', 'snake', 'dragon'];

                var randomNumber = Math.floor(Math.random() * sampleNames.length);

                if (names[i]) {
                    return names[i];
                }
                return sampleNames[randomNumber];
            }
            for (var i=0; i<num; i++) {
                var $box = $('<div></div>', {
                    'class': 'box col-md-2'
                }).appendTo($line);

                $('<input>', {
                    'class': 'form-control',
                    'type': 'text',
                    'name': 'chamber',
                    'value': getName(names, i)
                }).appendTo($box);
            }

            $('#nameBox').html('');
            $line.appendTo('#nameBox');
        }

        function getChamberNames() {
            return $("#cylinderSetupForm input[name='chamber']").map(function () {
                return $(this).val();
            }).get();
        }

        $(document).ready(function () {

            $("#numOfChamber").change(function() {
                redrawNameForm($(this).val());
            }).change();

            $("#btnReset").click(function() {
                var numOfChamber = $("#numOfChamber").val();
                var names = getChamberNames();
                console.log("numOfChamber=" + numOfChamber + "; names=" + names);

                socket.emit('reset', { num: numOfChamber, names: names });
            });

            reloadCylinder();
        });
    </script>
    <title>Russian Roulette</title>
</head>
<body>
<div class="container">

    <h2>다음 주인공은?</h2>
    <div id="roulette"></div>

    <div id="setupBox">
        <h2>설정</h2>
        <form name="cylinderSetupForm" id="cylinderSetupForm" action="">
        <div class="col-xs-2">
            <input type="number" id="numOfChamber" class="form-control" value="7">
        </div>
        <div id="nameBox" class="row">

        </div>
        <input id="btnReset" class="btn btn-primary" value="reset">
        </form>
    </div>


</div>

<footer class="footer">
    <div class="container">
        <p class="text-muted">author: <a href="https://github.com/junho85" target="_blank">https://github.com/junho85</a></p>
        <p class="text-muted">github: <a href="https://github.com/junho85/RussianRoulette" target="_blank">https://github.com/junho85/RussianRoulette</a></p>
        <p class="text-muted">gun shot, dry sound from <a href="http://soundbible.com/" target="_blank">http://soundbible.com/</a></p>
    </div>
</footer>


</body>
</html>